# Multi-layer rasters {.unnumbered}

At the end of this tutorial, you will be know how to:

- handle multilayer rasters   
- extract time series or vegetation indices from rasters   


## File format

You could get anything among netCDF, grid, tif.
All can be read with `terra::rast()`

## Load the datasets

```{r settings}
library(terra) |> suppressPackageStartupMessages()
library(mapview)
library(here) |> suppressPackageStartupMessages()
```

The basic data is the GBIF otter dataset. We want to characterize the past climate of these observations.

::: {.panel-tabset}

## local
```{r otter_local}
otter <- read.csv(here("data", "gbif_otter_2021_mpl50km.csv"))
```

## online
```{r otter_online}
#| eval: false
otter <- read.csv(
  "https://github.com/FRBCesab/spatial-r/raw/main/data/gbif_otter_2021_mpl50km.csv"
)
```
:::

```{r load_otter}
# transform into a spatial object
pt_otter <- vect(
  otter,
  geom = c("decimalLongitude", "decimalLatitude"),
  crs = "EPSG:4326"
)
```


## Monthly climate with CHELSA

```{r}
meantemp <- rast(here("data", "CHELSA_monthly_tas_2015_2021.tif")) 
meantemp

# shorten names 
time_chelsa <- substr(names(meantemp), 12, 18)
names(meantemp) <- time_chelsa
```

```{r}
pt_temp <- extract(meantemp, pt_otter, ID = FALSE)
summary(unlist(pt_temp))
```

```{r}
# transform to degree celsius
pt_tempC <- pt_temp-273.15

# plot
boxplot(pt_tempC, las=2, ylab="Temperature (*C)")
```

```{r}
mean_temp <- apply(pt_tempC,1,mean, na.rm=TRUE)
summary(mean_temp)
pt_otter$mean_temp <- mean_temp
plot(pt_otter, "mean_temp")
```

```{r}
cv_temp <- apply(pt_tempC,1, sd, na.rm=TRUE)/mean_temp
summary(cv_temp)
pt_otter$cv_temp <- cv_temp
plot(pt_otter, "cv_temp")
```

```{r}
# too old school
# pt_otter$month2 <- ifelse(pt_otter$month<10, paste0("0",pt_otter$month), pt_otter$month)
# pt_otter$time <- paste(pt_otter$month2, pt_otter$year, sep="_")
# better : 
pt_otter$time <- as.Date(pt_otter$eventDate) |> format("%m_%Y")

table(pt_otter$time)
# get temperature at the month of observation
xy <- cbind(1:nrow(pt_otter), match(pt_otter$time, names(pt_tempC)))
pt_otter$temp_obs <- pt_tempC[xy]
summary(pt_otter$temp_obs)
plot(pt_otter, "temp_obs")
```

## Daily climate with E-OBS

```{r}
rainfall <- rast(here("data", "EOBS_daily_rr_2011_2024.tif"))
time(rainfall)
```


```{r}
pt_rain <- extract(rainfall, pt_otter, ID=FALSE)
```

```{r}
dimnames(pt_rain)
names(pt_rain) <- time(rainfall)
dim(pt_rain)

# calculate cumulated rainfall
years <- format(time(rainfall), "%Y")
yearly_rain <- t(pt_rain) |> 
    rowsum(group = years, na.rm=TRUE) |> t()

boxplot(yearly_rain)

av_yearly_rain <- apply(yearly_rain, 1, mean)
pt_otter$av_annualpp <- av_yearly_rain
plot(pt_otter, "av_annualpp")
```

*Is precipitation correlated to temperature? elevation?*


*Exercice (advanced)* : get the rainfall amount 10 days before observation
```{r}
t_obs <- match(as.Date(pt_otter$eventDate),time(rainfall))
t_past <- t_obs - 9 # ideally check if not negative

rain_past10d <- sapply(1:nrow(pt_rain), function(i) sum(pt_rain[i, t_past[i]:t_obs[i]]))
summary(rain_past10d)

pt_otter$rain_past10d <- rain_past10d
plot(pt_otter, "rain_past10d")
```

**Recommendation**
In general, if points, faster to do it after extraction
If polygons, need to do the operation on the raster first.


TO BE ADDED: 
- summarize rasters per year and make map
- add correlation? or ecological interpretation?
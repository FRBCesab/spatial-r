# Multi-layer rasters {.unnumbered}

At the end of this tutorial, you will be know how to:

- handle multilayer rasters   
- extract time series or vegetation indices from rasters   


## File format

You could get anything among netCDF, grid, tif.
All can be read with `terra::rast()`

## Setup

<details>
<summary> Follow the setup instructions if you haven't followed previous tutorials</summary>

If haven't done it already, please follow the [setup instructions](https://frbcesab.github.io/spatial-r/chapters/01_setup.html).    

Let's start with loading the required packages.

```{r setting}
suppressPackageStartupMessages({
  library(mapview)
  library(here)
  library(sf)
  library(terra)
  library(exactextractr)
})
```

And the needed dataset (observations of otter in 2021 around Montpellier, France).

::: {.panel-tabset}

## local
```{r otter_local}
pt_otter <- vect(here("data", "gbif_otter_2021_mpl50km.gpkg"))
```

## online
```{r otter_online}
#| eval: false
pt_otter <- vect(
  "https://github.com/FRBCesab/spatial-r/raw/main/data/gbif_otter_2021_mpl50km.gpkg"
)
```

:::


## Monthly climate with CHELSA

```{r}
meantemp <- rast(here("data", "CHELSA_monthly_tas_2015_2021.tif"))
meantemp

# shorten names
time_chelsa <- substr(names(meantemp), 12, 18)
names(meantemp) <- time_chelsa
```

```{r}
pt_temp <- extract(meantemp, pt_otter, ID = FALSE)
summary(unlist(pt_temp))
```

```{r}
# transform to degree celsius
pt_tempC <- pt_temp - 273.15

# plot
boxplot(pt_tempC, las = 2, ylab = "Temperature (*C)")
```

```{r}
mean_temp <- apply(pt_tempC, 1, mean, na.rm = TRUE)
summary(mean_temp)
pt_otter$mean_temp <- mean_temp
plot(pt_otter, "mean_temp")
```

```{r}
cv_temp <- apply(pt_tempC, 1, sd, na.rm = TRUE) / mean_temp
summary(cv_temp)
pt_otter$cv_temp <- cv_temp
plot(pt_otter, "cv_temp")
```

```{r}
# too old school
# pt_otter$month2 <- ifelse(pt_otter$month<10, paste0("0",pt_otter$month), pt_otter$month)
# pt_otter$time <- paste(pt_otter$month2, pt_otter$year, sep="_")
# better :
pt_otter$time <- as.Date(pt_otter$eventDate) |> format("%m_%Y")

table(pt_otter$time)
# get temperature at the month of observation
xy <- cbind(1:nrow(pt_otter), match(pt_otter$time, names(pt_tempC)))
pt_otter$temp_obs <- pt_tempC[xy]
summary(pt_otter$temp_obs)
plot(pt_otter, "temp_obs")
```


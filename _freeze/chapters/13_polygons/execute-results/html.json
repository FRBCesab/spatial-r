{
  "hash": "7df808cee7da81aa53a60f62f7513d66",
  "result": {
    "engine": "knitr",
    "markdown": "# Polygons {.unnumbered}\n\n:::{.callout-important title=\"Summary\"}\nThis tutorial explores how to handle **spatial polygons** in R with `terra` package:\n\n- read a spatial object with [`terra::vect()`](https://search.r-project.org/CRAN/refmans/terra/html/vect.html)    \n- calculate the area of polygons with [`terra::expanse()`](https://search.r-project.org/CRAN/refmans/terra/html/expanse.html)    \n- extract values of polygons to points with [`terra::extract()`](https://search.r-project.org/CRAN/refmans/terra/html/extract.html)    \n- create buffers around points with [`terra::buffer()`](https://search.r-project.org/CRAN/refmans/terra/html/buffer.html)   \n- find intersection among two polygon layers with  [`terra::intersect()`](https://search.r-project.org/CRAN/refmans/terra/html/intersect.html)   \n\n:::\n\n:::{.callout-tip title=\"The ecologist mind\"}\nIn which type of habitats were the otters observed? To answer this question, we will need to discover another type of spatial vector: **polygons**.\n:::\n\n## Setup\n\n<details>\n<summary> Follow the setup instructions if you haven't followed the tutorial on [points](https://frbcesab.github.io/spatial-r/chapters/11_points.html)</summary>\n\nIf haven't done it already, please follow the [setup instructions](https://frbcesab.github.io/spatial-r/chapters/01_setup.html). Let's start with loading the required packages.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppressPackageStartupMessages({\n  library(mapview)\n  library(here)\n  library(sf)\n  library(terra)\n})\n```\n:::\n\n\n\n\n::: {.panel-tabset}\n\n## local\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npt_otter <- vect(here(\"data\", \"gbif_otter_2021_mpl50km.gpkg\"))\n```\n:::\n\n\n\n\n## online\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npt_otter <- vect(\n  \"https://github.com/FRBCesab/spatial-r/raw/main/data/gbif_otter_2021_mpl50km.gpkg\"\n)\n```\n:::\n\n\n\n\n:::\n\n</details>\n\n\n## Load polygons from a shapefile\n\nIn this example, we will load land cover information for the area of interest from [IGN data BD CARTO](https://geoservices.ign.fr/bdcarto).\n\n*Note that this dataset has rough resolution ([OSO](https://artificialisation.developpement-durable.gouv.fr/bases-donnees/oso-theia) or [Corine land cover](https://land.copernicus.eu/en/products/clc-backbone) would be more suited for real analysis), but it's perfect for our illustration and learning purposes.* \n\n\n::: {.panel-tabset}\n\n## terra\n\nYou can load vector data with the function [`terra::vect()`](https://search.r-project.org/CRAN/refmans/terra/html/vect.html). \n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlanduse <- vect(here(\"data\", \"BDCARTO-LULC_mpl50km.shp\"))\n```\n:::\n\n\n\n\n## sf\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlanduse_sf <- st_read(here(\"data\", \"BDCARTO-LULC_mpl50km.shp\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `BDCARTO-LULC_mpl50km' from data source \n  `/home/romain/GitHub/spatial-r/data/BDCARTO-LULC_mpl50km.shp' \n  using driver `ESRI Shapefile'\nSimple feature collection with 2910 features and 3 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 3.18983 ymin: 43.20373 xmax: 4.56447 ymax: 44.16754\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n:::\n\n\n\n\n## online\n\nIf you don't have the data locally (and won't use it repeatedly), you can load it directly with:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlanduse <- vect(\n  \"https://github.com/FRBCesab/spatial-r/raw/refs/heads/main/data/BDCARTO-LULC_mpl50km.shp\"\n)\n```\n:::\n\n\n\n\n:::\n\n\n:::{.callout-note title=\"Your turn\"}\n1. How many different polygons are used in the land cover of our study area?\n2. What is the coordinate reference system (CRS) of the loaded river data?\n3. How many land cover classes are there? Which class has the most polygons?\n:::\n\n<details>\n<summary>Click to see the answer</summary>\n\n1. There was ``2910`` polygons in the dataset. You can access it with `dim(landuse)`, `nrow(landuse)` or just by typing `landuse` in the console.  \n2. The coordinates are in ``WGS 84`` (EPSG ``4326``). You can access this information with `crs(landuse, describe = TRUE)` (or in `sf` with `st_crs(landuse_sf)`).\n3. The column that stored the cover classes is `nature`. You could identify it with `head(landuse)` or `names(landuse)`. There are ``12`` land cover classes,  ``Prairie`` is the class with most polygons (`table(landuse$nature)`).\n\n</details>\n\n\n## Visualization\n\nBefore comparing two spatial objects (the otters observations and the land cover), it is recommended to plot them and make sure their projection systems are the same and the extents match.   \n*Do not use the package `mapview` because it will automatically project the datasets.*\n\n\n::: {.panel-tabset}\n\n## terra\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(landuse, y = \"nature\", border = NA)\nplot(pt_otter, add = TRUE)\n```\n\n::: {.cell-output-display}\n![](13_polygons_files/figure-html/terramap_line-1.png){width=672}\n:::\n:::\n\n\n\n\n## sf\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(landuse_sf[\"nature\"], reset = FALSE, border = FALSE, axes = TRUE)\nplot(pt_otter, add = TRUE, pch = 16)\n```\n\n::: {.cell-output-display}\n![](13_polygons_files/figure-html/sfmap_line-1.png){width=672}\n:::\n:::\n\n\n\n\n:::{.callout-warning}\nWhen you want to overlay multiple spatial object with base plot from `sf`, don't forget to use the argument `reset=FALSE`.\n:::\n\n:::\n\n## Calculate area\n\n:::{.callout-tip title=\"The ecologist mind\"}\nWhat is the dominant land cover in our study area?\n:::\n\nThe function [`terra::expanse()`](https://search.r-project.org/CRAN/refmans/terra/html/expanse.html) calculates the area in $m^2$. When calculating areas, **be careful with projection systems**. Some are not suited to calculate areas. Prefer equal-area projections or use local projection systems (if your study area is small). \n\nLuckily, the package `terra` calculates by default the geodesic area (based on lat/long coordinates and considering Earth's curvature) which is the most accurate estimate and avoid errors due to wrongly used projection system.  \n\n\n::: {.panel-tabset}\n\n## terra\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# calculate the area in ha\narea_polygons <- expanse(landuse) * 0.0001\n# store the area as atribute\nlanduse$area_ha <- as.numeric(area_polygons)\n```\n:::\n\n\n\n\n## sf\n\nIn `sf`, it is recommended to project the dataset to a equal area projection, such as the Lambert azimuthal equal-area for Europe [EPSG:3035](https://epsg.io/3035).\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# project land cover to an equal-area projection system\nlanduse_3035 <- st_transform(landuse_sf, crs = 3035)\n# calculate area of polygons (in hectare)\narea_polygons <- st_area(landuse_3035) * 0.0001\n# store as attribute in landuse\nlanduse_3035$area_ha <- as.numeric(area_polygons)\n```\n:::\n\n\n\n\n:::\n\n\n:::{.callout-note title=\"Your turn\"}\n- Which are the largest land cover classes in our study area? Why?\n:::\n\n<details>\n<summary>Click to see the answer</summary>\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# see area per land use classes\narea_landuse <- tapply(landuse$area_ha, landuse$nature, sum)\nsort(area_landuse)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Rocher, éboulis Carrière, décharge     Sable, gravier      Marais salant \n          37.78454         1916.22618         2353.14638         3455.79520 \n  Zone d'activités  Marais, tourbière               Bâti       Broussailles \n       15224.16350        29467.47117        55654.39730        97923.34835 \n     Vigne, verger            Prairie          Eau libre              Forêt \n      206514.68518       206833.73332       272561.76875       278134.18692 \n```\n\n\n:::\n:::\n\n\n\n\nThe categories `Forêt` (=forest) and `Eau libre` (=running water) are the largest land covers. As it can be seen in the [previous map](https://frbcesab.github.io/spatial-r/chapters/13_polygons_files/figure-html/terramap_line-1.png), large part of the Mediterranean Sea is included in the land cover data.\n\n</details>\n\n\n## Mask the sea\n\n:::{.callout-tip title=\"The ecologist mind\"}\nOur study area was defined as a square buffer around Montpellier. This area include the Mediterranean Sea. It is recommended to mask the sea in order to consider only areas where otters could have been potentially spotted.\n:::\n\nThere are two approaches to mask an area: (1) identify which area to remove from the data itself, or (2) use a mask from another data source (this approach will be [shown when dealing with rasters](https://frbcesab.github.io/spatial-r/chapters/21_rasters.html#mask-the-sea)). In this case, it is easier and more accurate to detect directly from the data which polygons to remove. In fact, the largest polygon corresponds to the Mediterranean Sea. So we just need to remove it.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# the largest polygon correspond to the mediterranean\nlanduse$nature[which.max(landuse$area_ha)]\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Eau libre\"\n```\n\n\n:::\n\n```{.r .cell-code}\n# remove the largest polygon\nlanduse_nomed <- landuse[-which.max(landuse$area_ha), ]\n# visually verify the output\nplot(landuse_nomed, y = \"nature\", border = NA)\n```\n\n::: {.cell-output-display}\n![](13_polygons_files/figure-html/ex2-1.png){width=672}\n:::\n:::\n\n\n\n\nThen we can recalculate the percentage of land cover per class.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncover_ha <- tapply(landuse_nomed$area_ha, landuse_nomed$nature, sum)\n# percentage of land cover classes in the terrestrial study area\ncover_perc <- cover_ha / sum(cover_ha) * 100\n#show rounded values\nround(cover_perc, 2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n              Bâti       Broussailles Carrière, décharge          Eau libre \n              5.98              10.52               0.21               3.61 \n             Forêt      Marais salant  Marais, tourbière            Prairie \n             29.87               0.37               3.16              22.21 \n   Rocher, éboulis     Sable, gravier      Vigne, verger   Zone d'activités \n              0.00               0.25              22.18               1.64 \n```\n\n\n:::\n:::\n\n\n\n\n\n## Polygons to points\n\n:::{.callout-tip title=\"The ecologist mind\"}\nWhat is the land cover class at the location of the otters observations?\n:::\n\n\n::: {.panel-tabset}\n## terra\n\nWe can extract the land cover class of the points with [`terra::extract()`](https://search.r-project.org/CRAN/refmans/terra/html/extract.html): \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npt_landcover <- extract(landuse, pt_otter)\n```\n:::\n\n\n\n\n## sf\n\nWe can extract the land cover class of the points with [`sf::st_join()`](https://search.r-project.org/CRAN/refmans/sf/html/st_join.html): \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npt_landcover <- st_join(st_as_sf(pt_otter), landuse_sf)\n```\n:::\n\n\n\n\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# see the number of observations per land use classes\ntable(pt_landcover$nature)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n             Bâti      Broussailles         Eau libre             Forêt \n                8                17                 1                29 \nMarais, tourbière           Prairie     Vigne, verger \n                3                16                 9 \n```\n\n\n:::\n:::\n\n\n\n\n:::{.callout-note title=\"Your turn\"}\n- [stat] Which classes are over- or under- represented compare to the distribution of classes over the whole study area?\n:::\n\n<details>\n<summary>Click to see the answer</summary>\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# calculate the percentage of otters observations per class\ncover_obs_perc <- table(pt_landcover$nature) / nrow(pt_landcover) * 100\n# match all classes with the one from the observations\nm0 <- match(names(cover_perc), names(cover_obs_perc))\n# create a data.frame\ncover <- data.frame(\n  class = names(cover_perc),\n  all = as.numeric(cover_perc),\n  obs = as.numeric(cover_obs_perc[m0])\n)\n# non matchin elements = 0%\ncover[is.na(cover)] <- 0\n# calculate the difference between observed and expected\ncover$delta <- cover$obs - cover$all\n# add left margin to the plot\npar(mar = c(4, 8, 4, 1))\nbarplot(\n  cover$delta,\n  horiz = TRUE,\n  names = cover$class,\n  las = 1,\n  xlab = \"Difference between observed and expected cover (%)\"\n)\n```\n\n::: {.cell-output-display}\n![](13_polygons_files/figure-html/ex4-1.png){width=672}\n:::\n:::\n\n\n\n\n\n</details>\n\n## Polygons to polygons\n\n:::{.callout-tip title=\"The ecologist mind\"}\nWhat is the land cover distribution around the locations of the otters observations?\n:::\n\nTo characterize the area surrounding the observations, we need to (!) create buffers, (2) calculate the intersection among the buffers and the land cover, and (3) calculate the area of the land cover classes intersecting the buffers. \n\n### Create buffer\n\n::: {.panel-tabset}\n\n## terra\nWe can create buffer with [`terra::buffer()`](https://search.r-project.org/CRAN/refmans/terra/html/buffer.html). In our example, we will create buffers of 1km.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndist_buffer <- 1000 # buffer of 1000 m\npoly_otter <- buffer(pt_otter, dist_buffer)\n```\n:::\n\n\n\n\n## sf\n\n:::{.callout-warning}\n`sf` uses `s2` when the coordinates are geographic (e.g. EPSG:4326) which creates buffers with low quality (in `sf 1.0-21`, tested on 03/11/2025).  \nIt is recommended to use projected coordinates when using the function [`sf::st_buffer()`](https://search.r-project.org/CRAN/refmans/sf/html/geos_unary.html).\n:::\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndist_buffer <- 1000 # buffer of 1000 m\n# transform to an equal-area projection system: better for area\npt_otter_3035 <- st_as_sf(pt_otter) |> st_transform(3035)\npoly_otter_3035 <- st_buffer(pt_otter_3035, dist_buffer)\n```\n:::\n\n\n\n\n:::\n\n\n### Visualize buffer\n\nFor illustration, we only show the buffer around the first observation.\n\nThe parameter `ext` limit the map to the extent of the given spatial object.  \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# plot the land cover limited to the extent of the buffer\nplot(landuse, y = \"nature\", ext = poly_otter[1])\n# add the buffer as a line of width 2\nplot(poly_otter[1], lwd = 2, add = TRUE)\n# add the observation as a red dot\nplot(pt_otter[1], col = \"red\", add = TRUE)\n```\n\n::: {.cell-output-display}\n![](13_polygons_files/figure-html/map_buffer_terra-1.png){width=672}\n:::\n:::\n\n\n\n\n\n:::{.callout-note title=\"Your turn\"}\n- What are the areas of the newly created buffers? \n:::\n\n<details>\n<summary>Click to see the answer</summary>\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# calculate the area of the buffers\nbuffer_area <- expanse(poly_otter)\n# see the distribution of the buffer areas\nsummary(buffer_area)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n3128689 3128689 3128689 3128689 3128689 3128689 \n```\n\n\n:::\n\n```{.r .cell-code}\n# distribution of the buffer areas from sf\nsummary(st_area(poly_otter_3035))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n3140157 3140157 3140157 3140157 3140157 3140157 \n```\n\n\n:::\n:::\n\n\n\n\nThe difference with expected value of $3141593$ is due to the way buffers are defined (by default, in 40 points in `terra` and 120 points in `sf`). If you want more precise buffers, you can change the parameter `quadsegs` from the `terra::buffer()` function. The roundness of the buffers is not important for most cases. It is much more important that all buffers have the same area.\n\n\n</details>\n\n\n### Intersection among polygons\n\nWe can now intersect the buffers with the land cover information with the function [`terra::intersect()`](https://search.r-project.org/CRAN/refmans/terra/html/intersect.html).\n\n\n::: {.panel-tabset}\n\n## terra\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbuffer_landcover <- intersect(landuse, poly_otter)\n\n# visualize the intersection\n# not plotted here to lighten the webpage\n# mapview(buffer_landcover, z = \"nature\")\n\n# show a zoom on the land cover of the first buffer\nplot(\n  buffer_landcover[buffer_landcover$key %in% poly_otter$key[1]],\n  y = \"nature\"\n)\n```\n\n::: {.cell-output-display}\n![](13_polygons_files/figure-html/buffer_lulc_terra-1.png){width=672}\n:::\n:::\n\n\n\n\n## sf\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbuffer_landcover_sf <- st_intersection(poly_otter_3035, landuse_3035)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: attribute variables are assumed to be spatially constant throughout\nall geometries\n```\n\n\n:::\n\n```{.r .cell-code}\n# visualize the intersection (not plotted to lighten the webpage)\n# mapview(buffer_landcover, z = \"nature\")\n```\n:::\n\n\n\n\n:::\n\n### Land cover area per buffer \n\nWe need to update the area of the land cover intersecting the buffers.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Calculate area for each polygon\nbuffer_landcover$area_ha <- expanse(buffer_landcover) * 0.0001\n\n# Calculate area per buffer and nature class\nclass_area <- tapply(\n  buffer_landcover$area_ha,\n  list(buffer_landcover$key, buffer_landcover$nature),\n  sum\n)\n#replace NA by 0\nclass_area[is.na(class_area)] <- 0\n# calculate the area of the buffer\nsum_area <- rowSums(class_area)\n# calculate the percentage per class\nperc_class <- class_area / sum_area * 100\n\n# add margin at the bottom\npar(mar = c(7, 4, 1, 1))\nbarplot(apply(perc_class, 2, mean), las = 2, ylab = \"Percentage land cover\")\n```\n\n::: {.cell-output-display}\n![](13_polygons_files/figure-html/perc_lulc_terra-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "13_polygons_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
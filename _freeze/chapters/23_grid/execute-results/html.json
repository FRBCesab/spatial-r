{
  "hash": "910d6c60c51a3734e7a29a801025a370",
  "result": {
    "engine": "knitr",
    "markdown": "# Grid {.unnumbered}\n\n:::{.callout-important title=\"Summary\"}\nThis tutorial explore how to make a grid and transform observations into a grid with `terra` package:\n\n- import a multi-layer rasters with [`terra::rast()`](https://search.r-project.org/CRAN/refmans/terra/html/rast.html)   \n- extract information from rasters on points or polygons with [`terra::extract()`](https://search.r-project.org/CRAN/refmans/terra/html/extract.html)\n\n:::\n\n:::{.callout-tip title=\"The ecologist mind\"}\nIf we want to make some modeling, it can be needed to regroup observations into a grid.\n:::\n\n\n## Setup\n\n<details>\n<summary> Follow the setup instructions if you haven't followed previous tutorials</summary>\n\nIf haven't done it already, please follow the [setup instructions](https://frbcesab.github.io/spatial-r/chapters/01_setup.html).    \n\nLet's start with loading the required packages.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppressPackageStartupMessages({\n  library(mapview)\n  library(here)\n  library(terra)\n  # library(sf)\n  # library(exactextractr)\n})\n```\n:::\n\n\n\n\nNow load all the datasets attached to the observations of otters recorded in 2021 within a 50km buffer from Montpellier, France.  \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npt_otter <- vect(here(\"data\", \"gbif_otter_2021_mpl50km.gpkg\"))\nriver <- vect(here(\"data\", \"BDCARTO-River_mpl50km.gpkg\"))\nlanduse <- vect(here(\"data\", \"BDCARTO-LULC_mpl50km.shp\"))\nbdalti <- rast(here(\"data\", \"BDALTI_mpl50km.tif\"))\ntemperature <- rast(here(\"data\", \"CHELSA_monthly_tas_2015_2021.tif\"))\n```\n:::\n\n\n\n\n</details>\n\n## Create a grid\n\nKey issue : which resolution? which projection?\nresolution depends on your dataset, extent, and ecological question\nprojection depends on the dataset\n\nLet's start from our observation.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npt_2154 <- project(pt_otter, \"EPSG:2154\")\nres <- 5000 # 1km grid\ngrid <- rast(pt_2154, res = res)\ngrid\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nclass       : SpatRaster \nsize        : 17, 19, 1  (nrow, ncol, nlyr)\nresolution  : 5000, 5000  (x, y)\nextent      : 723524.6, 818524.6, 6245001, 6330001  (xmin, xmax, ymin, ymax)\ncoord. ref. : RGF93 v1 / Lambert-93 (EPSG:2154) \n```\n\n\n:::\n:::\n\n\n\n\n## Points to grid\n\nthe argument `fun=count` set that it calculate the number of points\nthe argument `background=0` set that f there is no point, the vale will be 0, instead of NA by default\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngrid_nobs <- rasterize(pt_2154, grid, fun = \"count\", background = 0)\n\nplot(grid_nobs)\n```\n\n::: {.cell-output-display}\n![](23_grid_files/figure-html/grid_nobs-1.png){width=672}\n:::\n:::\n\n\n\n\n## Lines to grid   \n\nlength of rivers\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nriver_2154 <- project(river, \"EPSG:2154\")\n\ngrid_river <- rasterizeGeom(river_2154, grid, fun = \"length\")\nplot(grid_river)\n```\n\n::: {.cell-output-display}\n![](23_grid_files/figure-html/grid_river-1.png){width=672}\n:::\n:::\n\n\n\n\n\n## Polygon to grid\n\npercentage of forest\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# select only the forest\nforest <- landuse[landuse$nature == \"ForÃªt\"]\n# project the polygons\nforest_2154 <- project(forest, \"EPSG:2154\")\n# rasterize\ngrid_forest <- rasterize(forest_2154, grid, cover = TRUE, background = 0)\n\nplot(grid_forest)\n```\n\n::: {.cell-output-display}\n![](23_grid_files/figure-html/grid_forest-1.png){width=672}\n:::\n:::\n\n\n\n\n## Resample raster\n\n### Elevation\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ngrid_alti <- resample(bdalti, grid, \"bilinear\")\nplot(grid_alti)\n```\n\n::: {.cell-output-display}\n![](23_grid_files/figure-html/grid_alti-1.png){width=672}\n:::\n:::\n\n\n\n\n### Temperature\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#calculate the average temperature in 2021\nin_2021 <- grep(\"2021\", names(temperature))\nmonthly_temp <- subset(temperature, in_2021)\nannual_temp <- mean(monthly_temp, na.rm = TRUE)\n# project (that's one of the only occasion when projection of raster)\ntemp_2154 <- project(annual_temp, \"EPSG:2154\")\ngrid_temp <- resample(temp_2154, grid, \"bilinear\")\nplot(grid_temp)\n```\n\n::: {.cell-output-display}\n![](23_grid_files/figure-html/grid_temp-1.png){width=672}\n:::\n:::\n\n\n\n\n## Merge all together\n\nIgnoring all concept of spatial bias or anything else\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nout <- c(grid_nobs, grid_river, grid_forest, grid_alti, grid_temp)\n\nnames(out) <- c(\"nobs\", \"river_m\", \"forest\", \"elevation_m\", \"temperature_K\")\n\nplot(out)\n```\n\n::: {.cell-output-display}\n![](23_grid_files/figure-html/merge-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nfrance_border <- geodata::gadm(\"FRA\", level = 0, path = here(\"data\"))\n# project the coast in Lambert-93\nfrance_2154 <- project(france_border, crs(bdalti))\n# mask (=set to NA) the pixels that are not in the polygon\nout_masked <- mask(out, france_2154)\nplot(out_masked)\n```\n\n::: {.cell-output-display}\n![](23_grid_files/figure-html/mask-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- data.frame(out_masked)\n\nm1 <- lm(nobs ~ river_m + forest + elevation_m + temperature_K, data = df)\nanova(m1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalysis of Variance Table\n\nResponse: nobs\n               Df  Sum Sq Mean Sq F value   Pr(>F)   \nriver_m         1   0.360  0.3602  0.5795 0.447163   \nforest          1   0.068  0.0682  0.1097 0.740722   \nelevation_m     1   0.623  0.6229  1.0021 0.317683   \ntemperature_K   1   5.463  5.4635  8.7896 0.003294 **\nResiduals     276 171.556  0.6216                    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n\n:::{.callout-note title=\"Your turn\"}\nDoes the spatial resolution has en effect on the results? Repeat the same process with a grid of 500m, 1km, or 10km resolution and compare the results. \n:::\n",
    "supporting": [
      "23_grid_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
{
  "hash": "05974a9bc31ce7da05d15d8e453ecd28",
  "result": {
    "engine": "knitr",
    "markdown": "# Multi-layer rasters {.unnumbered}\n\n:::{.callout-important title=\"Summary\"}\nThis tutorial explore how to handle **multi-layer rasters** in R with `terra` package:\n\n- import a multi-layer rasters with [`terra::rast()`](https://search.r-project.org/CRAN/refmans/terra/html/rast.html)   \n- extract information from rasters on points or polygons with [`terra::extract()`](https://search.r-project.org/CRAN/refmans/terra/html/extract.html)\n\n:::\n\n:::{.callout-tip title=\"The ecologist mind\"}\nHow are otters influenced by climate? It would be ineresting to get the climate at the time of the observations of otter. \nTo answer this question, we will need to discover another type of spatial data: **multi-layer rasters**.\n:::\n\n\n\n## Setup\n\n<details>\n<summary> Follow the setup instructions if you haven't followed previous tutorials</summary>\n\nIf haven't done it already, please follow the [setup instructions](https://frbcesab.github.io/spatial-r/chapters/01_setup.html).    \n\nLet's start with loading the required packages.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppressPackageStartupMessages({\n  library(mapview)\n  library(here)\n  library(terra)\n  # library(sf)\n  # library(exactextractr)\n})\n```\n:::\n\n\n\n\nNow load the observations of otters recorded in 2021 within a 50km buffer from Montpellier, France.  \n\n::: {.panel-tabset}\n\n## local\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npt_otter <- vect(here(\"data\", \"gbif_otter_2021_mpl50km.gpkg\"))\n```\n:::\n\n\n\n\n## online\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npt_otter <- vect(\n  \"https://github.com/FRBCesab/spatial-r/raw/main/data/gbif_otter_2021_mpl50km.gpkg\"\n)\n```\n:::\n\n\n\n\n:::\n\n</details>\n\n\n## Load monthly climate with CHELSA\n\nWe will use the monthly average temperature data from [CHELSA](https://www.chelsa-climate.org/) which has a spatial resolution of 1km. To see how we created the data for our case study, have a look at [this tutorial](https://frbcesab.github.io/spatial-r/chapters/31_toydata_mpl.html#get-climate-data-from-chelsa).   \n\n### Import\n\nThe function to read *most kind of* raster file is [`terra::rast()`](https://search.r-project.org/CRAN/refmans/terra/html/rast.html)\n\n::: {.panel-tabset}\n\n## local\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntemperature <- rast(here(\"data\", \"CHELSA_monthly_tas_2015_2021.tif\"))\n```\n:::\n\n\n\n\n## online\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl_github <- \"https://github.com/FRBCesab/spatial-r/raw/main/data/\"\ntemperature <- rast(paste0(url_github, \"CHELSA_monthly_tas_2015_2021.tif\"))\n```\n:::\n\n\n\n\n:::\n\n:::{.callout-note title=\"Your turn\"}\n1. What are the dimensions of the loaded temperature raster?\n2. What is the resolution of rasters? In which unit? Why?\n3. How can we get the name of the different layers?\n:::\n\n<details>\n<summary>Click to see the answer</summary>\n\n1. There are ``116``  rows,  ``165`` columns and ``84`` layers in the raster. You can access it with `dim(temperature)` or just by typing `temperature` in the console.   \n2. The spatial resolution of raster is ``0.0083, 0.0083`` decimal degrees (equal to ``29.9999999`` arc seconds). The resolution is expressed in degrees because the projection system is ``WGS 84`` (EPSG ``4326``). You can access these information with `res(temperature)` and `crs(temperature, describe = TRUE)`.   \n3. To access the name of the layers, type `names(temperature)`, they corresponds to monthly averaged temperature.\n</details>\n\n### Rename\nTo simplify the next steps, we will rename the layers with only their corresponding month and year.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# shorten names\ntime_chelsa <- substr(names(temperature), 12, 18)\nnames(temperature) <- time_chelsa\n```\n:::\n\n\n\n\n### Visualize\n\nLet's visualize the monthly temperature of 2021 \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# select the layers of 2021\nin_2021 <- grep(\"2021\", time_chelsa)\n# plot the 2021 temperature layers\nplot(temperature, in_2021)\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/rast_map-1.png){width=672}\n:::\n:::\n\n\n\n\n\n:::{.callout-note title=\"Your turn\"}\n- what is the unit of the temperature values?\n- mask the sea from the temperature raster. *addref to raster tutorial*\n:::\n\n<details>\n<summary>Click to see the answer 1</summary>\nThe temperature are expressed in Kelvin, as indicated in the [documentation of Chelsa-monthly dataset](https://www.chelsa-climate.org/datasets/chelsa_monthly) \n</details>\n\n<details>\n<summary>Click to see the answer 2</summary>\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# get the border of the country (level = 0)\nfrance_border <- geodata::gadm(\"FRA\", level = 0, path = here(\"data\"))\n\n# mask (=set to NA) the pixels that are not in the polygon\ntemperature <- mask(temperature, france_border)\n\nplot(temperature, in_2021)\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/mask_sea-1.png){width=672}\n:::\n:::\n\n\n\n\n</details>\n\n### Transform in degree Celsius\n\nWe can make algebra operations in rasters. For instance, we can transform Kelvin to degree celsius.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntemp_C <- temperature - 273.15\n# plot the 2021 temperature layers\nplot(temp_C, in_2021)\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/rast_transform-1.png){width=672}\n:::\n:::\n\n\n\n\n## Extract information on points\n\nSame as with simple raster, the function [`terra::extract()`](https://search.r-project.org/CRAN/refmans/terra/html/extract.html) will get the temperature values of all months at the location of the observations.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npt_temp <- extract(temp_C, pt_otter, ID = FALSE)\ndim(pt_temp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 83 84\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(unlist(pt_temp))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n   0.95    9.55   13.75   14.69   20.55   26.95 \n```\n\n\n:::\n:::\n\n\n\n\nThe extracted temperature (in `pt_temp`) are stored in a data.frame with rows corresponding to the otter observations, and column corresponding to the month.\n\nWe can see the seasonal variation of the temperature with a simple `boxplot()`\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# plot the seasonal variation of the mean temperature\nboxplot(pt_temp, las = 2, ylab = \"Temperature (*C)\")\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/boxplot_temp-1.png){width=672}\n:::\n:::\n\n\n\n\n### Average temperature\n\nWith all these monthly temperature values, we can calculate the average of monthly temperature for the period 2015-2021. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmean_temp <- apply(pt_temp, 1, mean, na.rm = TRUE)\n# distribution of average values\nsummary(mean_temp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n  10.74   14.04   14.74   14.69   15.76   16.31 \n```\n\n\n:::\n\n```{.r .cell-code}\n# attach the temperature as an attribute\npt_otter$mean_temp <- mean_temp\n\n# let's map the average temperature\nplot(pt_otter, \"mean_temp\")\nplot(france_border, add = TRUE)\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/mean_temp-1.png){width=672}\n:::\n:::\n\n\n\n\n### Seasonal variations\n\nAnother interesting indicators is the seasonality of monthly temperature measured as the coefficient of variation. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncv_temp <- apply(pt_temp, 1, sd, na.rm = TRUE) / mean_temp\nsummary(cv_temp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n 0.3334  0.3823  0.4326  0.4185  0.4445  0.5517 \n```\n\n\n:::\n\n```{.r .cell-code}\npt_otter$cv_temp <- cv_temp\nplot(pt_otter, \"cv_temp\")\nplot(france_border, add = TRUE)\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/cv_temp-1.png){width=672}\n:::\n:::\n\n\n\n\nObservations made closer to the sea have warmer climate and lower seasonal variations in temperature.\n\n\n### Temperature at the time of observation\n\nWe need to identify which temperature layer correspond to the time of the observations. For this we will use the date formatting in R. Make sure to have a look at the documentations of [`as.Date()`](https://search.r-project.org/R/refmans/base/html/as.Date.html) and [`strptime()`](https://search.r-project.org/R/refmans/base/html/strptime.html) if you want more details. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npt_otter$time <- as.Date(pt_otter$eventDate) |> format(\"%m_%Y\")\n\ntable(pt_otter$time)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n01_2021 02_2021 03_2021 04_2021 05_2021 06_2021 07_2021 08_2021 09_2021 10_2021 \n     12      11      11       8       3       6       4       3       6       7 \n11_2021 12_2021 \n      5       7 \n```\n\n\n:::\n:::\n\n\n\n\nNow that we have the same format for the name of the temperature layer and the time of the observations, we can get the temperature value at the time of observation.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# get temperature at the month of observation\nt_obs <- match(pt_otter$time, names(pt_temp))\nxy <- cbind(1:nrow(pt_otter), t_obs)\npt_otter$temp_obs <- pt_temp[xy]\nsummary(pt_otter$temp_obs)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n   4.55    7.75   10.35   12.44   15.75   23.85 \n```\n\n\n:::\n\n```{.r .cell-code}\nplot(pt_otter, \"temp_obs\")\nplot(france_border, add = TRUE)\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/match_temp-1.png){width=672}\n:::\n:::\n\n\n\n\n\n:::{.callout-note title=\"Your turn\"}\n2. Extracting values for 1km buffer around the observation. Repeat what we learnt for a single raster, but with the temperature raster.\n1. (advanced) Get the range of monhly temperature within the 12 months before the observation.\n:::\n\n<details>\n<summary>Click to see the answer 1 </summary>\nTemperature are slow changing variables, so no real need for buffer, but this is a good exercice.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# create buffers\npoly_otter <- buffer(pt_otter, 1000) # buffer of 1km\n# no need to project because everything is in WGS84\n# extract values for each layer\nmean_buffer_temp <- extract(\n  temp_C,\n  poly_otter,\n  fun = mean,\n  exact = TRUE,\n  ID = FALSE\n)\nboxplot(mean_buffer_temp, las = 2, ylab = \"Temperature (*C)\")\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/extract_buffer-1.png){width=672}\n:::\n:::\n\n\n\n\n</details>\n\n<details>\n<summary>Click to see the answer 2 </summary>\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# we start again from the matching time\nt_obs <- match(pt_otter$time, names(pt_temp))\n# then we want to get 11 month before the observation\nt_past <- t_obs - 11 # ideally check if not negative\n\n# calculate the difference of min-max value within he time period\ntemp_past12m <- sapply(1:nrow(pt_temp), function(i) {\n  diff(range(pt_temp[i, t_past[i]:t_obs[i]]))\n})\n\nsummary(temp_past12m)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n  16.00   17.35   18.00   17.81   18.60   20.00 \n```\n\n\n:::\n\n```{.r .cell-code}\n# attach to the attribute table\npt_otter$temp_range_12m <- temp_past12m\n\n# visualize the results\nplot(pt_otter, \"temp_range_12m\")\nplot(france_border, add = TRUE)\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/extract_12m-1.png){width=672}\n:::\n:::\n\n\n\n\n</details>\n",
    "supporting": [
      "22_multilayer_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
{
  "hash": "160ad5c3be4aa2e7e923f8a086d18c76",
  "result": {
    "engine": "knitr",
    "markdown": "# Multi-layer rasters {.unnumbered}\n\nAt the end of this tutorial, you will be know how to:\n\n- handle multilayer rasters   \n- extract time series or vegetation indices from rasters   \n\n\n## File format\n\nYou could get anything among netCDF, grid, tif.\nAll can be read with `terra::rast()`\n\n## Setup\n\n<details>\n<summary> Follow the setup instructions if you haven't followed previous tutorials</summary>\n\nIf haven't done it already, please follow the [setup instructions](https://frbcesab.github.io/spatial-r/chapters/01_setup.html).    \n\nLet's start with loading the required packages.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppressPackageStartupMessages({\n  library(mapview)\n  library(here)\n  library(sf)\n  library(terra)\n  library(exactextractr)\n})\n```\n:::\n\n\n\n\n\nAnd the needed dataset (observations of otter in 2021 around Montpellier, France).\n\n::: {.panel-tabset}\n\n## local\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npt_otter <- vect(here(\"data\", \"gbif_otter_2021_mpl50km.gpkg\"))\n```\n:::\n\n\n\n\n\n## online\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npt_otter <- vect(\n  \"https://github.com/FRBCesab/spatial-r/raw/main/data/gbif_otter_2021_mpl50km.gpkg\"\n)\n```\n:::\n\n\n\n\n\n:::\n\n\n## Monthly climate with CHELSA\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmeantemp <- rast(here(\"data\", \"CHELSA_monthly_tas_2015_2021.tif\"))\nmeantemp\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nclass       : SpatRaster \nsize        : 116, 165, 84  (nrow, ncol, nlyr)\nresolution  : 0.008333333, 0.008333333  (x, y)\nextent      : 3.191527, 4.566527, 43.19986, 44.16653  (xmin, xmax, ymin, ymax)\ncoord. ref. : lon/lat WGS 84 (EPSG:4326) \nsource      : CHELSA_monthly_tas_2015_2021.tif \nnames       : CHELS~V.2.1, CHELS~V.2.1, CHELS~V.2.1, CHELS~V.2.1, CHELS~V.2.1, CHELS~V.2.1, ... \nmin values  :       273.4,       271.5,       275.9,       278.8,       282.9,       287.1, ... \nmax values  :       283.8,       282.4,       285.5,       288.5,       293.3,       297.6, ... \n```\n\n\n:::\n\n```{.r .cell-code}\n# shorten names\ntime_chelsa <- substr(names(meantemp), 12, 18)\nnames(meantemp) <- time_chelsa\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\npt_temp <- extract(meantemp, pt_otter, ID = FALSE)\nsummary(unlist(pt_temp))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n  274.1   282.7   286.9   287.8   293.7   300.1 \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# transform to degree celsius\npt_tempC <- pt_temp - 273.15\n\n# plot\nboxplot(pt_tempC, las = 2, ylab = \"Temperature (*C)\")\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmean_temp <- apply(pt_tempC, 1, mean, na.rm = TRUE)\nsummary(mean_temp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n  10.74   14.04   14.74   14.69   15.76   16.31 \n```\n\n\n:::\n\n```{.r .cell-code}\npt_otter$mean_temp <- mean_temp\nplot(pt_otter, \"mean_temp\")\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncv_temp <- apply(pt_tempC, 1, sd, na.rm = TRUE) / mean_temp\nsummary(cv_temp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n 0.3334  0.3823  0.4326  0.4185  0.4445  0.5517 \n```\n\n\n:::\n\n```{.r .cell-code}\npt_otter$cv_temp <- cv_temp\nplot(pt_otter, \"cv_temp\")\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# too old school\n# pt_otter$month2 <- ifelse(pt_otter$month<10, paste0(\"0\",pt_otter$month), pt_otter$month)\n# pt_otter$time <- paste(pt_otter$month2, pt_otter$year, sep=\"_\")\n# better :\npt_otter$time <- as.Date(pt_otter$eventDate) |> format(\"%m_%Y\")\n\ntable(pt_otter$time)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n01_2021 02_2021 03_2021 04_2021 05_2021 06_2021 07_2021 08_2021 09_2021 10_2021 \n     12      11      11       8       3       6       4       3       6       7 \n11_2021 12_2021 \n      5       7 \n```\n\n\n:::\n\n```{.r .cell-code}\n# get temperature at the month of observation\nxy <- cbind(1:nrow(pt_otter), match(pt_otter$time, names(pt_tempC)))\npt_otter$temp_obs <- pt_tempC[xy]\nsummary(pt_otter$temp_obs)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n   4.55    7.75   10.35   12.44   15.75   23.85 \n```\n\n\n:::\n\n```{.r .cell-code}\nplot(pt_otter, \"temp_obs\")\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "22_multilayer_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}
{
  "hash": "d86aabc3df68157eab5ae8ab0c914ae4",
  "result": {
    "engine": "knitr",
    "markdown": "# Multi-layer rasters {.unnumbered}\n\n:::{.callout-important title=\"Summary\"}\nThis tutorial explores how to handle **multi-layer rasters** in {{< fa brands r-project >}} with `terra` package:\n\n- import a multi-layer rasters with [`terra::rast()`](https://search.r-project.org/CRAN/refmans/terra/html/rast.html)   \n- extract information from rasters on points or polygons with [`terra::extract()`](https://search.r-project.org/CRAN/refmans/terra/html/extract.html)\n\n:::\n\n:::{.callout-tip title=\"The ecologist mind\"}\nHow are otters influenced by climate? We need to get the climatic conditions **where and when** the otters were observed. To get such data, we need to discover another type of spatial data: **multi-layer rasters**.\n:::\n\n\n\n## Setup\n\n<details>\n<summary> Follow the setup instructions if you haven't followed previous tutorials</summary>\n\nIf haven't done it already, please follow the [setup instructions](https://frbcesab.github.io/spatial-r/chapters/01_setup.html).    \n\nLet's start with loading the required packages.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsuppressPackageStartupMessages({\n  library(mapview)\n  library(here)\n  library(terra)\n})\n```\n:::\n\n\n\n\nNow load the observations of otters recorded in 2021 within a 50km buffer from Montpellier, France.  \n\n::: {.panel-tabset}\n\n## local\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npt_otter <- vect(here(\"data\", \"gbif_otter_2021_mpl50km.gpkg\"))\n```\n:::\n\n\n\n\n## online\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npt_otter <- vect(\n  \"https://github.com/FRBCesab/spatial-r/raw/main/data/gbif_otter_2021_mpl50km.gpkg\"\n)\n```\n:::\n\n\n\n\n:::\n\n</details>\n\n\n## Load monthly climate data\n\nWe will use the monthly average temperature data from [CHELSA](https://www.chelsa-climate.org/) which has a spatial resolution of 1km. To see how we created the data for our case study, have a look at [this tutorial](https://frbcesab.github.io/spatial-r/chapters/31_toydata_mpl.html#get-climate-data-from-chelsa).   \n\n### Import\n\nThe function to import *most kind of* raster file in {{< fa brands r-project >}} is [`terra::rast()`](https://search.r-project.org/CRAN/refmans/terra/html/rast.html)\n\n::: {.panel-tabset}\n\n## local\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntemperature <- rast(here(\"data\", \"CHELSA_monthly_tas_2015_2021.tif\"))\n```\n:::\n\n\n\n\n## online\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl_github <- \"https://github.com/FRBCesab/spatial-r/raw/main/data/\"\ntemperature <- rast(paste0(url_github, \"CHELSA_monthly_tas_2015_2021.tif\"))\n```\n:::\n\n\n\n\n:::\n\n:::{.callout-note title=\"Your turn\"}\n1. What are the dimensions of the loaded temperature raster?\n2. What is the resolution of rasters? In which unit?\n3. What are the different layers and how can we get their names?\n:::\n\n<details>\n<summary>Click to see the answer</summary>\n\n1. There are ``116``  rows,  ``165`` columns and ``84`` layers in the raster. You can access it with `dim(temperature)` or just by typing `temperature` in the console.   \n2. The spatial resolution of raster is ``0.0083`` decimal degrees (equal to ``30`` arc seconds). The resolution is expressed in degrees because the projection system is ``WGS 84`` (EPSG ``4326``). You can access these information with `res(temperature)` and `crs(temperature, describe = TRUE)` or just by typing `temperature` in the console.      \n3. The different layers correspond to monthly averaged temperature. To access the name of the layers, type `names(temperature)`.\n</details>\n\n### Rename\nTo simplify the next steps, we will rename the layers with only their corresponding month and year.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# shorten names\ntime_chelsa <- substr(names(temperature), 12, 18)\nnames(temperature) <- time_chelsa\n```\n:::\n\n\n\n\n### Visualize\n\nLet's visualize the monthly temperature of 2021 with the function [`plot()`](https://search.r-project.org/CRAN/refmans/terra/html/plot.html). To set a commun color scale among layers, we use the parameter `range`.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# select the layers of 2021\nin_2021 <- grep(\"2021\", time_chelsa)\n\n# plot the 2021 temperature layers\nplot(temperature, in_2021, range = range(values(temperature)))\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/rast_map-1.png){width=672}\n:::\n:::\n\n\n\n\n\n:::{.callout-note title=\"Your turn\"}\n1. What is the unit of the temperature values?\n2. Mask the sea from the temperature raster with the land boundary of France (as in the [Chapter Rasters](https://frbcesab.github.io/spatial-r/chapters/21_rasters.html#mask-the-sea)). \n:::\n\n<details>\n<summary>Click to see the answer 1</summary>\nThe temperature are expressed in Kelvin, as indicated in the [documentation of Chelsa-monthly dataset](https://www.chelsa-climate.org/datasets/chelsa_monthly) \n</details>\n\n<details>\n<summary>Click to see the answer 2</summary>\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# get the border of the country (level = 0)\nfrance_border <- readRDS(here(\"data\", \"gadm41_FRA_0_pk.rds\"))\n# or directly from geodata\n# france_border <- geodata::gadm(\"FRA\", level = 0, path = here(\"data\"))\n\n# mask (=set to NA) the pixels that are not in the polygon\ntemperature <- mask(temperature, france_border)\n\nplot(\n  temperature,\n  in_2021,\n  range = range(values(temperature))\n)\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/mask-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n</details>\n\n### Transform in degree Celsius\n\nWe can make algebra operations in rasters. For instance, we can transform Kelvin to degree celsius.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntemp_C <- temperature - 273.15\n# calculate the range of temperature values\nrange_T <- range(values(temp_C))\n# add otters observations in each layer with `fun`\nplot(\n  temp_C,\n  in_2021,\n  range = range_T,\n  plg = list(title = \"(째C)\"),\n  fun = function() points(pt_otter)\n)\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/rast_transform-1.png){width=672}\n:::\n:::\n\n\n\n\n\n## Extract information on points\n\nSimilar to simple raster, the function [`terra::extract()`](https://search.r-project.org/CRAN/refmans/terra/html/extract.html) will get the temperature values of all months (= all layers) at the location of the observations.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npt_temp <- extract(temp_C, pt_otter, ID = FALSE)\ndim(pt_temp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 83 84\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(unlist(pt_temp))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n   0.95    9.55   13.75   14.69   20.55   26.95 \n```\n\n\n:::\n:::\n\n\n\n\nThe extracted temperature (in `pt_temp`) are stored in a data.frame with rows corresponding to otters observations, and columns corresponding to  months.\n\nWe can visualize the seasonal variation of the temperature with a simple `boxplot()`\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# plot the seasonal variation of the mean temperature\nboxplot(pt_temp, las = 2, ylab = \"Temperature (*C)\")\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/boxplot_temp-1.png){width=672}\n:::\n:::\n\n\n\n\n### Average temperature\n\n:::{.callout-tip title=\"The ecologist mind\"}\nHaving one temperature variable per month is not informative, because these variables are highly correlated. So we need to summarize the information in term of average temperature or seasonal variation. \n:::\n\nWith these monthly temperature values, we can calculate the average of monthly temperature for the period 2015-2021. \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# apply(x, 1, mean) will calculate the mean over rows\nmean_temp <- apply(pt_temp, 1, mean, na.rm = TRUE)\n# distribution of average values\nsummary(mean_temp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n  10.74   14.04   14.74   14.69   15.76   16.31 \n```\n\n\n:::\n\n```{.r .cell-code}\n# attach the temperature as an attribute\npt_otter$mean_temp <- mean_temp\n\n# let's map the average temperature\nplot(\n  pt_otter,\n  \"mean_temp\",\n  type = \"continuous\",\n  main = \"Average 2015-2021 temperature\",\n  plg = list(title = \"(째C)\")\n)\nplot(france_border, add = TRUE)\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/mean_temp-1.png){width=672}\n:::\n:::\n\n\n\n\n### Seasonal variations\n\nAnother interesting indicators is the seasonality of monthly temperature, which we can measure as the coefficient of variation (= the ratio of the standard deviation to the mean). \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# calculate the standard deviation\nsd_temp <- apply(pt_temp, 1, sd, na.rm = TRUE)\n# get the coefficient of variation\ncv_temp <- sd_temp / mean_temp\n# distribution of temperature seasonality\nsummary(cv_temp)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n 0.3334  0.3823  0.4326  0.4185  0.4445  0.5517 \n```\n\n\n:::\n\n```{.r .cell-code}\n# let's map the temperature seasonality\n# attach the value to the spatial points\npt_otter$cv_temp <- cv_temp\n# create the map\nplot(\n  pt_otter,\n  \"cv_temp\",\n  main = \"Temperature seasonality\",\n  type = \"continuous\"\n)\nplot(france_border, add = TRUE)\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/cv_temp-1.png){width=672}\n:::\n:::\n\n\n\n\nObservations made closer to the sea have warmer climate and lower seasonal variations in temperature.\n\n\n### Temperature at the time of observation\n\n:::{.callout-tip title=\"The ecologist mind\"}\nInstead of the average climate in the time period 2015-2021, otters observations might also be affected by the weather at the time of observation (here approximated by the month of the observation).\n:::\n\nWe need to identify which temperature layer correspond to the time of the observations. For this we will use the date formatting in {{< fa brands r-project >}}. If you want more details, have a look at the documentations of [`as.Date()`](https://search.r-project.org/R/refmans/base/html/as.Date.html) and [`strptime()`](https://search.r-project.org/R/refmans/base/html/strptime.html) . \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npt_otter$time <- as.Date(pt_otter$eventDate) |> format(\"%m_%Y\")\n\ntable(pt_otter$time)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n01_2021 02_2021 03_2021 04_2021 05_2021 06_2021 07_2021 08_2021 09_2021 10_2021 \n     12      11      11       8       3       6       4       3       6       7 \n11_2021 12_2021 \n      5       7 \n```\n\n\n:::\n:::\n\n\n\n\nWe now have the same format for the name of the temperature layer and the time of the observations, so we can get the temperature value at the time of observation.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# identify the matching layer corresponding to the time of observation\nt_obs <- match(pt_otter$time, names(pt_temp))\n\n# get the values\nxy <- cbind(1:nrow(pt_otter), t_obs)\npt_otter$temp_obs <- pt_temp[xy]\n\n# distribution of the monthly temperature corresponding to the observation\nsummary(pt_otter$temp_obs)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n   4.55    7.75   10.35   12.44   15.75   23.85 \n```\n\n\n:::\n\n```{.r .cell-code}\n# mapping the new indicator\nplot(\n  pt_otter,\n  \"temp_obs\",\n  main = \"Monthly temperature\",\n  type = \"continuous\",\n  plg = list(title = \"(째C)\")\n)\nplot(france_border, add = TRUE)\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/match_temp-1.png){width=672}\n:::\n:::\n\n\n\n\n\n:::{.callout-note title=\"Your turn\"}\n2. Extract the average temperature in 2015-2021 for 1km buffers around the observations. Use buffers as explained in the [Chapter Rasters](https://frbcesab.github.io/spatial-r/chapters/21_rasters.html#create-buffer).\n1. (advanced) Calculate the range of monthly temperature within the 12 months before the observations, and make a map.\n:::\n\n<details>\n<summary>Click to see the answer 1 </summary>\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# create buffers\npoly_otter <- buffer(pt_otter, 1000) # buffer of 1km\n# no need to project because everything is in WGS84\n# extract values for each layer\nmean_buffer_temp <- extract(\n  temp_C,\n  poly_otter,\n  fun = mean,\n  exact = TRUE,\n  ID = FALSE\n)\nboxplot(mean_buffer_temp, las = 2, ylab = \"Temperature (*C)\")\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/extract_buffer-1.png){width=672}\n:::\n:::\n\n\n\n\n</details>\n\n<details>\n<summary>Click to see the answer 2 </summary>\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# we start from the matching time\nt_obs <- match(pt_otter$time, names(pt_temp))\n# then we want to get 11 months before the observation\nt_past <- t_obs - 11 # ideally check if not negative\n\n# calculate the difference of min-max value within the time period\ntemp_past12m <- sapply(1:nrow(pt_temp), function(i) {\n  diff(range(pt_temp[i, t_past[i]:t_obs[i]]))\n})\n\n# distribution of the temperature range\nsummary(temp_past12m)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n  16.00   17.35   18.00   17.81   18.60   20.00 \n```\n\n\n:::\n\n```{.r .cell-code}\n# attach to the attribute table\npt_otter$temp_range_12m <- temp_past12m\n\n# visualize the results\nplot(\n  pt_otter,\n  \"temp_range_12m\",\n  main = \"Past 12-months temperature range\",\n  type = \"continuous\",\n  plg = list(title = \"(째C)\")\n)\nplot(france_border, add = TRUE)\n```\n\n::: {.cell-output-display}\n![](22_multilayer_files/figure-html/extract_12m-1.png){width=672}\n:::\n:::\n\n\n\n\n</details>\n",
    "supporting": [
      "22_multilayer_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}